1. 目前现状

- 共6个表厂：金卡、上海真兰、蓝宝石、松川、天信、正泰。
- 天信是接触式cpu卡，其它都是4442卡或者102卡，天信主要是大表。
- 正泰的远传表（抄表器抄表模式）已经准备开始启用。
- 各厂家制卡，只需要卡号、气量、次数等内容，没有补卡次数等其它内容。
- 天信表只在天然气公司售气，银行不用处理天信表，也就是银行不用处理cpu卡表。

1. 对各表厂统一要求

- 根据统一的接口规范制作动态库。
- 提供动态库demo测试，demo测试必须用vc写，其提供源代码。天信表只能提供c#调用，无法提供vc调用。
- 各表厂需提供工具卡制作接口。
- 各表厂需提供表上返回码含义说明文档。
- 各表厂能通过购气卡从表上采集到每月用气量等信息的，要在动态库里提供。

2. 读卡器统一

- 采用明华可支持cpu卡的读卡器，天信的psam模块需要插入该读卡器中。

3. 判卡

- 经了解，所有厂家判卡均不会对卡进行密码核对，且不会冲突。

4. 读写卡过程

- 对4442卡
  * 读卡时，由客户端读取卡上所有内容，发给服务器，由服务器获取卡上内容结果返回给客户端。
  * 写卡，由客户端读取卡上所有内容，把内容及要气量等参数发给服务器，由服务器获得写卡内容及写卡密码，进行写卡。

- 对102卡
  * 读卡
    1. 由客户端先读取公共区内容，获得卡密码（读卡、写卡密码相同）。
    1. 根据卡密码读取1区及2区所有内容，连带公共区内容，一起发给服务器，由服务器获取卡上内容结果返回给客户端。
  * 写卡
    1. 由客户端将公共区、1区、2区所有内容以及气量等写卡参数发给服务器，由服务器获得写卡内容及写卡密码返回给客户端。

- 对cpu卡
  * 直接调用表厂动态库，由表厂动态库直接操作卡片。

6. 读写卡标准

- 4442卡
  * 发新卡/补卡
    extern "C" __declspec(dllexport) int__stdcall WriteNew4442Card
    (
      unsigned char *kh, int ql, __int16 cs, __int16 klx,
      unsigned char *data, unsigned char* oldKey, unsigned char* newKey
    )
    - kh：输入参数，用户卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输入参数，发卡时所带气量，必须时整数。
    - cs：输入参数，写卡次数，发卡时次数为1，补卡时为实际写卡次数。
    - klx：输入参数，1 民用表 2 工业表。
    - data：输出参数，要写到卡上的所有数据，hex串。
    - oldKey：输出参数，写卡前要核对的密码。
    - newKey：输出参数，写到卡上的新密码。
  * 读卡
    extern "C" __declspec(dllexport) int__stdcall Read4442Card
    (
      unsigned char *data,
      unsigned char *kh, int *ql, __int16  *cs, __int16 *klx
    )
    - data：输入参数，从卡上读取的数据，hex串格式。
    - kh：输出参数，从数据中解析出来的卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输出参数，从数据中解析出来的气量，整形。
    - cs：输出参数，从数据中解析出来的次数。
    - klx：输出参数，从数据库解析出来的卡类型，1 民用表 2 工业表
  * 购气/退气，退气时，气量传0
    extern "C" __declspec(dllexport) int__stdcall Buy4442Card
    (
      unsigned char *source, unsigned char *kh, int ql, __int16 cs,
      unsigned char *dest, unsigned char* oldKey, unsigned char* newKey
    )
    - source：输入参数，卡上原来的数据
    - kh：输入参数，用户卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输入参数，发卡时所带气量，必须时整数。
    - cs：输入参数，每次购气自动+1。
    - dest：输出参数，要写到卡上的所有数据，hex串。
    - oldKey：输出参数，写卡前要核对的密码。
    - newKey：输出参数，写到卡上的新密码。
  * 擦卡
    extern "C" __declspec(dllexport) int__stdcall Format4442Card
    (
      unsigned char *source, unsigned char* oldKey
    )
    - source：输入数据，卡上数据
    - oldKey：输出参数，清除卡上数据时，要核对的密码。
  * 判卡
    extern "C" __declspec(dllexport) int __stdcall Check4442Card(unsigned char *source)
    - source：输入数据，卡上的数据
    - return：0 是本厂家用户卡， 1 是本厂家清零卡，-1 不是本厂家卡。

- 102卡
  * 发新卡/补卡
    extern "C" __declspec(dllexport) int__stdcall WriteNew102Card
    (
      unsigned char *kh, int ql, __int16 cs, __int16 klx,
      unsigned char *data, unsigned char* oldKey, unsigned char* newKey
    )
    - kh：输入参数，用户卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输入参数，发卡时所带气量，必须时整数。
    - cs：输入参数，写卡次数，发卡时次数为1，补卡时为实际写卡次数。
    - klx：输入参数，1 民用表 2 工业表。
    - data：输出参数，要写到卡上的所有数据，hex串，按公共区，用户1区，用户2区顺序连接。
    - oldKey：输出参数，写卡前要核对的新卡密码。
    - newKey：输出参数，写到卡上的新密码。
  * 读卡
    extern "C" __declspec(dllexport) int__stdcall Read102Card
    (
      unsigned char *data,
      unsigned char *kh, int *ql, __int16  *cs, __int16 *klx
    )
    - data：输入参数，从卡上读取的数据，hex串格式，按公共区，用户1区，用户2区顺序连接。
    - kh：输出参数，从数据中解析出来的卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输出参数，从数据中解析出来的气量，整形。
    - cs：输出参数，从数据中解析出来的次数。
    - klx：输出参数，从数据库解析出来的卡类型，1 民用表 2 工业表
  * 购气/退气，退气时，气量传0
    extern "C" __declspec(dllexport) int__stdcall Buy102Card
    (
      unsigned char *source, unsigned char *kh, int ql, __int16 cs,
      unsigned char *dest, unsigned char* oldKey, unsigned char* newKey
    )
    - source：输入参数，卡上原来的数据，hex串格式，按公共区，用户1区，用户2区顺序连接。
    - kh：输入参数，用户卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输入参数，发卡时所带气量，必须时整数。
    - cs：输入参数，每次购气自动+1。
    - dest：输出参数，要写到卡上的所有数据，hex串，按公共区，用户1区，用户2区顺序连接。
    - oldKey：输出参数，写卡前要核对的密码。
    - newKey：输出参数，写到卡上的新密码。
  * 擦卡
    extern "C" __declspec(dllexport) int__stdcall Format102Card
    (
      unsigned char *source, unsigned char* oldKey
    )
    - source：输入数据，卡上数据
    - oldKey：输出参数，清除卡上数据时，要核对的密码。
  * 判卡
    extern "C" __declspec(dllexport) int __stdcall Check102Card
    (
      unsigned char *source, unsigned char *oldKey
    )
    - source：输入数据，公共区数据
    - oldKey：输出数据，进一步读取用户1区，用户2区时，需要的密码。
    - return：0 是本厂家用户卡， 1 是本厂家清零卡，-1 不是本厂家卡。

- cpu卡
  * 发新卡/补卡
    extern "C" __declspec(dllexport) int__stdcall WriteNew102Card
    (
      __int16 com, unsigned char *kh, int ql, __int16 cs, __int16 klx
    )
    - com：输入参数，端口号，从0开始。  
    - kh：输入参数，用户卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输入参数，发卡时所带气量，必须时整数。
    - cs：输入参数，写卡次数，发卡时次数为1，补卡时为实际写卡次数。
    - klx：输入参数，1 民用表 2 工业表。
  * 读卡
    extern "C" __declspec(dllexport) int__stdcall Read102Card
    (
      __int16 com,
      unsigned char *kh, int *ql, __int16  *cs, __int16 *klx
    )
    - com：输入参数，端口号，从0开始。  
    - kh：输出参数，c字符串类型，位数不限，以'\0'结束。
    - ql：输出参数，气量，整形。
    - cs：输出参数，次数。
    - klx：输出参数，1 民用表 2 工业表
  * 购气/退气，退气时，气量传0
    extern "C" __declspec(dllexport) int__stdcall Buy102Card
    (
      __int16 com, unsigned char *kh, int ql, __int16 cs
    )
    - com：输入参数，端口号，从0开始。  
    - kh：输入参数，用户卡号，c字符串类型，位数不限，以'\0'结束。
    - ql：输入参数，气量，必须是整数。
    - cs：输入参数，每次购气自动+1。
  * 擦卡
    extern "C" __declspec(dllexport) int__stdcall Format102Card
    (
      __int16 com, unsigned char *kh
    )
    - com：输入参数，端口号，从0开始。  
    - kh：输入参数，c字符串类型，位数不限，以'\0'结束。
  * 判卡
    extern "C" __declspec(dllexport) int __stdcall Check102Card
    (
      __int16 com
    )
    - com：输入参数，端口号，从0开始。  

7. 未来卡格式标准

- 卡型采用CPU卡
- cpu卡文件格式由天然气公司自己建立
- 天然气公司建立自己的秘钥体系

8. 远传表

- 由天然气公司统一表的通讯协议。
